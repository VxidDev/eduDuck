{% extends "base.html" %}

{% block title %}{{ _('EduDuck - Note Analysis Results') }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='noteAnalyzer/result-style.css') }}">
    <script>
        window.CURRENT_USERNAME = "{{ current_user.username if current_user.is_authenticated else '' }}";

        // Jinja template variable (server-rendered)
        window.ANALYSIS_DATA = {{ analysis | tojson | safe }};
        
        window.ANALYSIS_ID = "{{ request.args.get('id', '') }}";
    </script>
{% endblock %}

{% block content %}
    <div class="main-content">
        <div class="results-container">
            {% if analysis and analysis.overall_score is defined %}
                <!-- Overall Score Card -->
                <div class="score-card">
                    <h1 class="score-title">{{ _('Note Analysis Results') }}</h1>

                    <div class="overall-score">
                        <div class="score-value {% if analysis.overall_score >= 80 %}score-excellent{% elif analysis.overall_score >= 60 %}score-good{% elif analysis.overall_score >= 40 %}score-needs-work{% else %}score-poor{% endif %}">
                            {{ analysis.overall_score }}%
                        </div>
                        <p class="score-label">{{ _('Overall Quality Score') }}</p>
                        <p class="score-subtitle">{{ _('Based on') }} {{ analysis.sections | length }} {{ _('section') }}{% if analysis.sections | length != 1 %}{{ _('s') }}{% endif %} {{ _('analyzed') }}</p>
                    </div>

                    {% if analysis.overall_score >= 80 %}
                        <p class="interpretation excellent">
                            <strong>{{ _('Excellent!') }}</strong> {{ _('Your notes are comprehensive and well-structured.') }}
                        </p>
                    {% elif analysis.overall_score >= 60 %}
                        <p class="interpretation good">
                            <strong>{{ _('Good Foundation!') }}</strong> {{ _('Your notes cover the basics well. Review the suggestions below to make them even better.') }}
                        </p>
                    {% elif analysis.overall_score >= 40 %}
                        <p class="interpretation needs-work">
                            <strong>{{ _('Needs Improvement.') }}</strong> {{ _('There are several areas that need attention. Focus on the suggestions below.') }}
                        </p>
                    {% else %}
                        <p class="interpretation poor">
                            <strong>{{ _('Significant Gaps Detected.') }}</strong> {{ _('Your notes need major improvements. Start with high-priority issues first.') }}
                        </p>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="{{ url_for('note_analyzer_page') }}" class="button secondary">{{ _('Analyze Another') }}</a>
                    <a href="{{ url_for('note_analyzer_export', id=request.args.get('id', '')) }}" class="button secondary">{{ _('Export Analysis') }}</a>
                </div>

                <!-- Sections Analysis -->
                <div class="sections-container">
                    <h2 class="sections-title">{{ _('Detailed Analysis') }}</h2>

                    {% for section in analysis.sections %}
                        <div class="section-card">
                            <div class="section-header">
                                <h3 class="section-title">{{ section.title }}</h3>
                                <span class="confidence-badge {% if section.confidence >= 80 %}confidence-high{% elif section.confidence >= 60 %}confidence-medium{% else %}confidence-low{% endif %}">
                                    {{ _('Confidence') }}: {{ section.confidence }}%
                                </span>
                            </div>

                            {% if section.issues and section.issues | length > 0 %}
                                <div class="section-content issues-section">
                                    <h4 class="content-title issues-title">{{ _('Issues Identified') }}</h4>
                                    <ul class="content-list">
                                        {% for issue in section.issues %}
                                            <li>{{ issue }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}

                            {% if section.why_it_matters and section.why_it_matters | length > 0 %}
                                <div class="section-content why-section">
                                    <h4 class="content-title why-title">{{ _('Why It Matters') }}</h4>
                                    <ul class="content-list">
                                        {% for reason in section.why_it_matters %}
                                            <li>{{ reason }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}

                            {% if section.suggestions and section.suggestions | length > 0 %}
                                <div class="section-content suggestions-section">
                                    <h4 class="content-title suggestions-title">{{ _('Suggestions for Improvement') }}</h4>
                                    <ul class="content-list">
                                        {% for suggestion in section.suggestions %}
                                            <li>{{ suggestion }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- Next Steps -->
                <div class="next-steps">
                    <h3>{{ _('Next Steps') }}</h3>
                    <ol class="steps-list">
                        <li>{{ _('Address high-priority issues first (sections with lower confidence scores)') }}</li>
                        <li>{{ _('Implement 2-3 suggestions per study session to avoid overwhelm') }}</li>
                        <li>{{ _('Re-analyze your notes after improvements to track progress') }}</li>
                        <li>{{ _('Use') }} <a href="{{ url_for('note_enhancer_page') }}" class="inline-link">{{ _('Note Enhancer') }}</a> {{ _('for AI-powered improvements') }}</li>
                        <li>{{ _('Test your understanding by generating a') }} <a href="{{ url_for('quiz_generator_page') }}" class="inline-link">{{ _('quiz') }}</a> {{ _('from your notes') }}</li>
                    </ol>
                </div>

                <!-- Footer Actions -->
                <div class="footer-actions">
                    <a href="{{ url_for('note_analyzer_page') }}" class="button primary">{{ _('Analyze More Notes') }}</a>
                    <a href="{{ url_for('quiz_generator_page', topic=analysis.sections[0].title if analysis.sections else '') }}" class="button secondary">{{ _('Generate Quiz') }}</a>
                    <a href="{{ url_for('note_enhancer_page') }}" class="button secondary">{{ _('Enhance Notes') }}</a>
                </div>

            {% else %}
                <!-- No Analysis Found -->
                <div class="error-container">
                    <div class="error-icon">⚠️</div>
                    <h2>{{ _('Analysis Not Found') }}</h2>
                    <p>{{ _("We couldn't find the analysis you're looking for. It may have expired or the link is incorrect.") }}</p>
                    <a href="{{ url_for('note_analyzer_page') }}" class="button primary">{{ _('Analyze New Notes') }}</a>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}